{% extends "base.html" %} {% block extrahead %}
<!-- Prevent search engine indexing -->
<meta name="robots" content="noindex, nofollow" />

<!-- Netlify Identity Widget -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
{% endblock %} {% block scripts %} {{ super() }}

<!-- Netlify Identity Login Logic -->
<script>
  if (window.netlifyIdentity) {
    const loginRedirectKey = "netlify-login-redirect";
    const canonicalElement = document.querySelector('link[rel="canonical"]');
    const canonicalHref = canonicalElement?.getAttribute("href") ?? window.location.href;
    const siteRootUrl = new URL(".", canonicalHref);
    const loginUrl = new URL("login/", siteRootUrl);
    const homeUrl = siteRootUrl;

    const normalizePath = (url) => url.pathname.replace(/\/+$/, "/");
    const currentUrl = new URL(window.location.href);
    const isLoginPage = normalizePath(currentUrl) === normalizePath(loginUrl);
    const currentLocation = currentUrl.href;

    const navigateTo = (url) => window.location.replace(url.href);

    const handleLogin = () => {
      window.netlifyIdentity.off("login", handleLogin);
      window.netlifyIdentity.close();

      const target = sessionStorage.getItem(loginRedirectKey);
      if (target) {
        sessionStorage.removeItem(loginRedirectKey);
        const targetUrl = new URL(target, siteRootUrl);
        window.location.assign(targetUrl.href);
        return;
      }

      if (isLoginPage) {
        navigateTo(homeUrl);
        return;
      }

      window.location.reload();
    };

    window.netlifyIdentity.on("init", (user) => {
      if (user) {
        if (isLoginPage) {
          const storedTarget = sessionStorage.getItem(loginRedirectKey);
          sessionStorage.removeItem(loginRedirectKey);
          if (storedTarget && storedTarget !== currentLocation) {
            const storedUrl = new URL(storedTarget, siteRootUrl);
            navigateTo(storedUrl);
            return;
          }

          navigateTo(homeUrl);
        }
        return;
      }

      if (!sessionStorage.getItem(loginRedirectKey) && !isLoginPage) {
        sessionStorage.setItem(loginRedirectKey, currentLocation);
      }

      window.netlifyIdentity.on("login", handleLogin);
      window.netlifyIdentity.open();
    });

    window.netlifyIdentity.on("logout", () => {
      sessionStorage.removeItem(loginRedirectKey);
      window.netlifyIdentity.close();
      navigateTo(loginUrl);
    });

    window.netlifyIdentity.init();
  }
</script>
{% endblock %}
