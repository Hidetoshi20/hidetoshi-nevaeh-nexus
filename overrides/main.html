{% extends "base.html" %} {% block extrahead %}
<!-- Prevent search engine indexing -->
<meta name="robots" content="noindex, nofollow" />

<!-- Netlify Identity Widget -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
{% endblock %} {% block scripts %} {{ super() }}

<!-- Netlify Identity Login Logic -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    if (!window.netlifyIdentity) {
      return;
    }

    const loginRedirectKey = "netlify-login-redirect";
    const currentUrl = new URL(window.location.href);
    const loginTrigger = document.getElementById("netlify-login-trigger");
    const isLoginPage = Boolean(loginTrigger);

    const canonicalElement = document.querySelector('link[rel="canonical"]');
    let siteRootUrl;

    if (canonicalElement?.href) {
      try {
        const candidate = new URL(canonicalElement.href);
        if (candidate.hostname === window.location.hostname) {
          siteRootUrl = candidate;
        }
      } catch (error) {
        console.warn("Netlify Identity: invalid canonical URL", error);
      }
    }

    if (!siteRootUrl) {
      siteRootUrl = new URL("/", window.location.href);
    }

    const loginUrl = new URL("login/", siteRootUrl);
    const homeUrl = siteRootUrl;

    const getRedirectTarget = () => sessionStorage.getItem(loginRedirectKey);
    const clearRedirectTarget = () => sessionStorage.removeItem(loginRedirectKey);
    const navigateTo = (url) => window.location.assign(url.href);

    const resolveTargetUrl = (value) => {
      try {
        return new URL(value, siteRootUrl);
      } catch (error) {
        console.warn("Netlify Identity: invalid redirect target", value, error);
        return null;
      }
    };

    const handleLogin = () => {
      window.netlifyIdentity.off("login", handleLogin);
      window.netlifyIdentity.close();

      const storedTarget = getRedirectTarget();
      if (storedTarget) {
        clearRedirectTarget();
        const targetUrl = resolveTargetUrl(storedTarget);
        if (targetUrl) {
          navigateTo(targetUrl);
          return;
        }
      }

      if (isLoginPage) {
        navigateTo(homeUrl);
        return;
      }

      window.location.reload();
    };

    window.netlifyIdentity.on("init", (user) => {
      if (user) {
        if (isLoginPage) {
          const storedTarget = getRedirectTarget();
          clearRedirectTarget();

          if (storedTarget && storedTarget !== currentUrl.href) {
            const targetUrl = resolveTargetUrl(storedTarget);
            if (targetUrl) {
              navigateTo(targetUrl);
              return;
            }
          }

          navigateTo(homeUrl);
        }
        return;
      }

      if (!isLoginPage && !getRedirectTarget()) {
        sessionStorage.setItem(loginRedirectKey, currentUrl.href);
      }

      window.netlifyIdentity.on("login", handleLogin);
      window.netlifyIdentity.open();
    });

    window.netlifyIdentity.on("logout", () => {
      clearRedirectTarget();
      window.netlifyIdentity.close();
      navigateTo(loginUrl);
    });

    window.netlifyIdentity.init();
  });
</script>
{% endblock %}
